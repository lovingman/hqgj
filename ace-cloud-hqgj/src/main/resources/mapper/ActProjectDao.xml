<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huacainfo.ace.zcpa.dao.ActProjectDao">
    <resultMap id="BaseResultMap" type="com.huacainfo.ace.zcpa.model.ActProject">
        <id column="id" jdbcType="VARCHAR" property="id"/>
        <result column="projectCode" jdbcType="VARCHAR" property="projectCode"/>
        <result column="projectName" jdbcType="VARCHAR" property="projectName"/>
        <result column="projectLevel" jdbcType="VARCHAR" property="projectLevel"/>
        <result column="category" jdbcType="VARCHAR" property="category"/>
        <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
        <result column="startTime" jdbcType="TIMESTAMP" property="startTime"/>
        <result column="endTime" jdbcType="TIMESTAMP" property="endTime"/>
        <result column="summary" jdbcType="VARCHAR" property="summary"/>
        <result column="projectState" jdbcType="VARCHAR" property="projectState"/>
        <result column="actTimes" jdbcType="INTEGER" property="actTimes"/>
        <result column="overallScore" jdbcType="DECIMAL" property="overallScore"/>
        <result column="partakeDuration" jdbcType="DECIMAL" property="partakeDuration"/>
        <result column="anomalyTimes" jdbcType="INTEGER" property="anomalyTimes"/>
        <result column="fmUrl" jdbcType="VARCHAR" property="fmUrl"/>
        <result column="nineteenJiFen" jdbcType="INTEGER" property="nineteenJiFen"/>
        <result column="jiFen" jdbcType="INTEGER" property="jiFen"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="createUserId" jdbcType="VARCHAR" property="createUserId"/>
        <result column="createUserName" jdbcType="VARCHAR" property="createUserName"/>
        <result column="createDate" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="lastModifyUserId" jdbcType="VARCHAR" property="lastModifyUserId"/>
        <result column="lastModifyUserName" jdbcType="VARCHAR" property="lastModifyUserName"/>
        <result column="lastModifyDate" jdbcType="TIMESTAMP" property="lastModifyDate"/>
        <result column="pid" jdbcType="VARCHAR" property="pid"/>
        <result column="peopleNumber" jdbcType="INTEGER" property="peopleNumber"/>

    </resultMap>
    <sql id="Base_Column_List">
    id, projectCode, projectName, projectLevel, category, areaCode, startTime, endTime,
    summary, projectState, actTimes, overallScore, partakeDuration, anomalyTimes,, fmUrl,
    nineteenJiFen, jiFen, remark, status, createUserId, createUserName, createDate, lastModifyUserId,
    lastModifyUserName, lastModifyDate,pid,peopleNumber
  </sql>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from act_project
    where id = #{id,jdbcType=VARCHAR}
  </delete>
    <insert id="insert" parameterType="com.huacainfo.ace.zcpa.model.ActProject">
    insert into act_project (id, projectCode, projectName,
      projectLevel, category, areaCode,
      startTime, endTime, summary,
      projectState, actTimes, overallScore,
      partakeDuration, anomalyTimes, fmUrl,
      nineteenJiFen, jiFen,  remark,
      status, createUserId, createUserName,
      createDate, lastModifyUserId, lastModifyUserName,
      lastModifyDate,pid,peopleNumber)
    values (#{id,jdbcType=VARCHAR}, #{projectCode,jdbcType=VARCHAR}, #{projectName,jdbcType=VARCHAR},
      #{projectLevel,jdbcType=VARCHAR}, #{category,jdbcType=VARCHAR}, #{areaCode,jdbcType=VARCHAR},
      #{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP}, #{summary,jdbcType=VARCHAR},
      #{projectState,jdbcType=VARCHAR}, #{actTimes,jdbcType=INTEGER}, #{overallScore,jdbcType=DECIMAL},
      #{partakeDuration,jdbcType=DECIMAL}, #{anomalyTimes,jdbcType=INTEGER}, #{fmUrl,jdbcType=VARCHAR},
      #{nineteenJiFen,jdbcType=INTEGER}, #{jiFen,jdbcType=INTEGER}, #{remark,jdbcType=VARCHAR},
      #{status,jdbcType=VARCHAR}, #{createUserId,jdbcType=VARCHAR}, #{createUserName,jdbcType=VARCHAR},
      #{createDate,jdbcType=TIMESTAMP}, #{lastModifyUserId,jdbcType=VARCHAR}, #{lastModifyUserName,jdbcType=VARCHAR},
      #{lastModifyDate,jdbcType=TIMESTAMP}, #{pid,jdbcType=VARCHAR},#{peopleNumber,jdbcType=INTEGER})
  </insert>
    <update id="updateByPrimaryKey" parameterType="com.huacainfo.ace.zcpa.model.ActProject">
    update act_project
    set projectName = #{projectName,jdbcType=VARCHAR},
      projectLevel = #{projectLevel,jdbcType=VARCHAR},
      category = #{category,jdbcType=VARCHAR},
      areaCode = #{areaCode,jdbcType=VARCHAR},
      startTime = #{startTime,jdbcType=TIMESTAMP},
      endTime = #{endTime,jdbcType=TIMESTAMP},
      summary = #{summary,jdbcType=VARCHAR},
      projectState = #{projectState,jdbcType=VARCHAR},
      actTimes = #{actTimes,jdbcType=INTEGER},
      overallScore = #{overallScore,jdbcType=DECIMAL},
      partakeDuration = #{partakeDuration,jdbcType=DECIMAL},
      anomalyTimes = #{anomalyTimes,jdbcType=INTEGER},
      fmUrl = #{fmUrl,jdbcType=VARCHAR},
      nineteenJiFen = #{nineteenJiFen,jdbcType=INTEGER},
      jiFen = #{jiFen,jdbcType=INTEGER},
      remark = #{remark,jdbcType=VARCHAR},
      status = #{status,jdbcType=VARCHAR},
      lastModifyUserId = #{lastModifyUserId,jdbcType=VARCHAR},
      lastModifyUserName = #{lastModifyUserName,jdbcType=VARCHAR},
      lastModifyDate = #{lastModifyDate,jdbcType=TIMESTAMP},
      peopleNumber=#{peopleNumber,jdbcType=INTEGER}
    where id = #{id,jdbcType=VARCHAR}
  </update>
    <resultMap extends="BaseResultMap" id="VoResultMap" type="com.huacainfo.ace.zcpa.vo.ActProjectVo">
        <result column="areaName" jdbcType="VARCHAR" property="areaName"/>
        <result column="developNum" jdbcType="INTEGER" property="developNum"/>
        <result column="ycNum" jdbcType="INTEGER" property="ycNum"/>
        <result column="score" jdbcType="INTEGER" property="score"/>
        <result column="volHour" jdbcType="INTEGER" property="volHour"/>
        <result column="needNum" jdbcType="INTEGER" property="needNum"/>
        <result column="isToday" jdbcType="INTEGER" property="isToday"/>

    </resultMap>
    <sql id="Vo_Column_List">
    t.id, t.projectCode, t.projectName, t.projectLevel, t.category, t.areaCode, t.startTime, t.endTime, t.summary, t.projectState, t.actTimes,
    t.overallScore, t.partakeDuration, t.anomalyTimes,t.fmUrl, t.nineteenJiFen, t.jiFen, t.remark, t.status,t.pid,t.peopleNumber
  </sql>

    <sql id="Vo_ActPerson_List">
     p.id  personid, p.personName ppersonName, p.sex psex, p.idCard pidCard, p.cateogry pcateogry, p.phone pphone, p.areaCode pareaCode, p.nowAddr pnowAddr
    </sql>

    <sql id="Vo_ActFamilyVolunteer_List">
    fv.id fvid, fv.areaCode fvareaCode, fv.projectId fvprojectId, fv.targetId fvtargetId, fv.volunteerId fvvolunteerId, fv.aidTargetType fvaidTargetType
    </sql>

    <sql id="Vo_ActFamilyTarget_List">
    ft.id ftid, ft.areaCode ftareaCode, ft.projectId ftprojectId, ft.personId ftpersonId
    </sql>
    <sql id="Vo_baseVolunteer_List">
        bv.id bvid, bv.name bvname, bv.sex bvsex, bv.mobile bvmobile,bv.idCard bvidCard, bv.userType bvuserType, bv.orgId bvorgId,
        bv.areaCode bvareaCode, bv.homeAreaCode bvhomeAreaCode, bv.homeAddr bvhomeAddr,bv.nowAreaCode bvnowAreaCode, bv.nowAddr bvnowAddr
    </sql>

    <sql id="Vo_ActSchool_List">
        s.id sid, s.schoolName sschoolName, s.unicode sunicode,  s.areaCode sareaCode, s.detailAddr sdetailAddr, s.dutyName sdutyName,
         s.phone sphone, s.nowAddr snowAddr
    </sql>

    <sql id="Vo_ActProjectTarget_List">
    pt.id ptid, pt.areaCode ptareaCode, pt.projectId ptprojectId, pt.targetId pttargetId, pt.targetType pttargetType
    </sql>
    <sql id="Vo_ActProjectVolunteer_List">
     pv.id pvid, pv.areaCode pvareaCode, pv.projectId pvprojectId, pv.volunteerId pvvolunteerId,pv.isSignUp pvisSignUp
    </sql>
    <sql id="Vo_ActProjectTopic_List">
      apt.id aptid, apt.areaCode aptareaCode, apt.projectId aptprojectId, apt.projectCategory aptprojectCategory, apt.targetId apttargetId,
       apt.content aptcontent, apt.startTime aptstartTime, apt.endTime aptendTime, apt.acceptState aptacceptState, apt.volunteerNum aptvolunteerNum,
       apt.title
    </sql>

    <sql id="From_Statement">
    FROM act_project t
    left join  portal_zcpa.province zp on zp.code=t.areaCode
  </sql>
    <sql id="Where_Condition">
        <where>
            1 = 1
            <if test="condition.projectCode != null and condition.projectCode !=''">
                and t.projectCode = #{condition.projectCode,jdbcType=VARCHAR}
            </if>
            <if test="condition.projectName != null and condition.projectName !=''">
                and t.projectName = #{condition.projectName,jdbcType=VARCHAR}
            </if>
            <if test="condition.category != null and condition.category !=''">
                and t.category = #{condition.category,jdbcType=VARCHAR}
            </if>
            <if test="condition.areaCode != null and condition.areaCode !=''">
                and (t.areaCode='4307' or t.areaCode like concat(#{condition.areaCode,jdbcType=VARCHAR},'%'))
            </if>
            <if test="condition.region != null and condition.region !=''">
                and t.areaCode like concat(#{condition.region,jdbcType=VARCHAR},'%')
            </if>
            <if test="condition.startTime != null">
                and t.startTime <![CDATA[ >= ]]> #{condition.startTime,jdbcType=TIMESTAMP}
            </if>
            <if test="condition.endTime != null">
                and t.startTime <![CDATA[ <= ]]> #{condition.endTime,jdbcType=TIMESTAMP}
            </if>
            <if test="condition.states != null and condition.states !=''">
                and t.projectState in
                <foreach collection="condition.states" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="condition.createUserId != null and condition.createUserId !=''">
                and t.createUserId = #{condition.createUserId,jdbcType=VARCHAR}
            </if>
            <if test="condition.projectLevel != null and condition.projectLevel !=''">
                and t.projectLevel = #{condition.projectLevel,jdbcType=VARCHAR}
            </if>
            <if test='condition.projectLevel == null|| condition.projectLevel ==""'>
                and t.projectLevel in ('0','1')
            </if>
            <if test="condition.pid != null and condition.pid !=''">
                and t.pid = #{condition.pid,jdbcType=VARCHAR}
            </if>
        </where>
    </sql>
    <select id="selectVoByPrimaryKey" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List"/>,p.name as areaName,
        (select count(1) from act_project_topic topic where topic.projectId=t.id) as developNum,
        (select count(1) from act_project_activity a where a.projectId=t.id and a.isYc='y' and a.`status` = '1') as ycNum,
        (select count(1) from  act_project_activity a WHERE  a.volunteerId=#{volunteerId,jdbcType=VARCHAR} and
         (DATE_FORMAT(NOW(),"%Y-%m-%d")) = (DATE_FORMAT(a.createDate,"%Y-%m-%d")) and a.status!='2') as isToday,
        case when  ISNULL(t.peopleNumber)then 0
        when ((t.peopleNumber- (select count(1) from act_project_volunteer where projectId=t.id))<![CDATA[ < ]]>0)then 0
        else (t.peopleNumber- (select count(1) from act_project_volunteer where projectId=t.id))
        end needNum,
        SUM(v.score) as score,
        SUM(v.volHour) as volHour
        from act_project t
        left join (
        SELECT
        t.projectId,
        IFNULL(t.activityJiFen,0) as score,
        CASE when ISNULL(t.startTime) then 0
        when ISNULL(t.endTime) then 0
        ELSE timestampdiff(HOUR,t.startTime, t.endTime) END volHour
        FROM `act_project_activity` t
        where t.`status` = '1'
        )v on v.projectId = t.id
        left join  portal_zcpa.province p on p.code=t.areaCode
        where t.id = #{id,jdbcType=VARCHAR}
    </select>
    <select id="findList" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List"/>,
        case zp.type
        when '4' then   '常德市'
        when '3' then   concat_ws(">",'常德市',zp.name)
        when '2' then   concat_ws(">", ppp.ppNames,pp.pName,zp.name)
        when '1' then   concat_ws(">",'常德市', ppp.ppNames,pp.pName,zp.name)
        end  areaName
        <include refid="From_Statement"/>
        left join (	select
        name as pName, p.`code` as pCode, parent_code as ppCode
        from portal_zcpa.province p
        )pp on pp.pCode = zp.parent_code
        left join  (select
        name as ppNames, p.`code` as pppcode
        from portal_zcpa.province p
        )ppp on ppp.pppcode = pp.ppCode
        <include refid="Where_Condition"/>
        <choose>
            <when test='orderBy!=null and orderBy!=""'>
                ORDER BY t.${orderBy}
            </when>
            <otherwise>
                ORDER BY t.createDate desc
            </otherwise>
        </choose>
        limit #{start,jdbcType=DECIMAL}, #{limit,jdbcType=DECIMAL}
    </select>
    <select id="findCount" resultType="int">
        SELECT COUNT(*)
        <include refid="From_Statement"/>
        <include refid="Where_Condition"/>
    </select>
    <select id="isExist" parameterType="com.huacainfo.ace.zcpa.model.ActProject" resultType="int">
            select count(1)
        from act_project
        where 1=1 and  category=#{category,jdbcType=VARCHAR}
        and projectLevel='0' and projectState !='4'
  </select>
    <delete id="deleteByIds">
        delete from act_project
        where id in
        <foreach collection="array" item="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <update id="updateProjectState" parameterType="java.lang.String"  >
     update act_project
     set projectState =#{projectState,jdbcType=VARCHAR}
     where id = #{id,jdbcType=VARCHAR}
    </update>
    <update id="updateCoverUrl">
      update act_project
      set fmUrl = #{coverUrl,jdbcType=VARCHAR}
      where id = #{projectId,jdbcType=VARCHAR}
    </update>

    <resultMap id="VoResultMap2" type="com.huacainfo.ace.zcpa.vo.ActProjectVo" extends="BaseResultMap">
        <result column="areaName" jdbcType="VARCHAR" property="areaName"/>
        <association property="actProject" column="id" javaType="com.huacainfo.ace.zcpa.model.ActProject">
            <id column="id" jdbcType="VARCHAR" property="id"/>
            <result column="projectCode" jdbcType="VARCHAR" property="projectCode"/>
            <result column="projectName" jdbcType="VARCHAR" property="projectName"/>
            <result column="projectLevel" jdbcType="VARCHAR" property="projectLevel"/>
            <result column="pid" jdbcType="VARCHAR" property="pid"/>
            <result column="category" jdbcType="VARCHAR" property="category"/>
            <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="startTime" jdbcType="TIMESTAMP" property="startTime"/>
            <result column="endTime" jdbcType="TIMESTAMP" property="endTime"/>
            <result column="summary" jdbcType="VARCHAR" property="summary"/>
            <result column="projectState" jdbcType="VARCHAR" property="projectState"/>
            <result column="actTimes" jdbcType="INTEGER" property="actTimes"/>
            <result column="overallScore" jdbcType="DECIMAL" property="overallScore"/>
            <result column="partakeDuration" jdbcType="DECIMAL" property="partakeDuration"/>
            <result column="anomalyTimes" jdbcType="INTEGER" property="anomalyTimes"/>
            <result column="fmUrl" jdbcType="VARCHAR" property="fmUrl"/>
            <result column="nineteenJiFen" jdbcType="INTEGER" property="nineteenJiFen"/>
            <result column="jiFen" jdbcType="INTEGER" property="jiFen"/>
            <result column="remark" jdbcType="VARCHAR" property="remark"/>
            <result column="status" jdbcType="VARCHAR" property="status"/>
        </association>
        <collection property="actFamilyTarget" column="id" ofType="com.huacainfo.ace.zcpa.vo.ActFamilyTargetVo">
            <id column="ftid" jdbcType="VARCHAR" property="id"/>
            <result column="ftareaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="ftprojectId" jdbcType="VARCHAR" property="projectId"/>
            <result column="ftpersonId" jdbcType="VARCHAR" property="personId"/>

            <result column="ppersonName" jdbcType="VARCHAR" property="ppersonName" />
            <result column="psex" jdbcType="VARCHAR" property="psex" />
            <result column="pidCard" jdbcType="VARCHAR" property="pidCard" />
            <result column="pcateogry" jdbcType="VARCHAR" property="pcateogry" />
            <result column="pphone" jdbcType="VARCHAR" property="pphone" />
            <result column="pnowAddr" jdbcType="VARCHAR" property="pnowAddr" />

            <collection property="actFamilyVolunteer" column="id" ofType="com.huacainfo.ace.zcpa.vo.ActFamilyVolunteerVo">
                <id column="fvid" jdbcType="VARCHAR" property="id" />
                <result column="fvareaCode" jdbcType="VARCHAR" property="areaCode" />
                <result column="fvprojectId" jdbcType="VARCHAR" property="projectId" />
                <result column="fvtargetId" jdbcType="VARCHAR" property="targetId" />
                <result column="fvvolunteerId" jdbcType="VARCHAR" property="volunteerId" />
                <result column="bvsex" jdbcType="VARCHAR" property="sex" />
                <result column="bvname" jdbcType="VARCHAR" property="name" />
                <result column="bvmobile" jdbcType="VARCHAR" property="mobile" />
                <result column="bvidCard" jdbcType="VARCHAR" property="idCard" />
                <result column="bvuserType" jdbcType="VARCHAR" property="userType" />
            </collection>
        </collection>
    </resultMap>

    <sql id="From_Statement_List">
	 from act_project t
     left join act_family_target ft on t.id=ft.projectId
     left join act_person p on ft.personId = p.id
     left join act_family_volunteer fv on fv.targetId=ft.id
     left join base_volunteer bv on bv.id = fv.volunteerId
     left join  portal_zcpa.province p on p.code=t.areaCode
	</sql>

    <select id="selectById" parameterType="java.lang.String" resultMap="VoResultMap2">
        select
        <include refid="Vo_Column_List"/>,p.name as areaName,
        <include refid="Vo_ActPerson_List"/>,
        <include refid="Vo_ActFamilyVolunteer_List"/>,
        <include refid="Vo_ActFamilyTarget_List"/>,
        <include refid="Vo_baseVolunteer_List"/>
        <include refid="From_Statement_List"/>
        where t.id= #{id,jdbcType=VARCHAR} and t.category='1'
    </select>


    <resultMap id="VoResultMap3" type="com.huacainfo.ace.zcpa.vo.ActProjectVo" extends="BaseResultMap">
        <result column="areaName" jdbcType="VARCHAR" property="areaName"/>
        <association property="actProject" column="id" javaType="com.huacainfo.ace.zcpa.model.ActProject">
            <id column="id" jdbcType="VARCHAR" property="id"/>
            <result column="projectCode" jdbcType="VARCHAR" property="projectCode"/>
            <result column="projectName" jdbcType="VARCHAR" property="projectName"/>
            <result column="projectLevel" jdbcType="VARCHAR" property="projectLevel"/>
            <result column="category" jdbcType="VARCHAR" property="category"/>
            <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="startTime" jdbcType="TIMESTAMP" property="startTime"/>
            <result column="endTime" jdbcType="TIMESTAMP" property="endTime"/>
            <result column="summary" jdbcType="VARCHAR" property="summary"/>
            <result column="projectState" jdbcType="VARCHAR" property="projectState"/>
            <result column="actTimes" jdbcType="INTEGER" property="actTimes"/>
            <result column="overallScore" jdbcType="DECIMAL" property="overallScore"/>
            <result column="partakeDuration" jdbcType="DECIMAL" property="partakeDuration"/>
            <result column="anomalyTimes" jdbcType="INTEGER" property="anomalyTimes"/>
            <result column="fmUrl" jdbcType="VARCHAR" property="fmUrl"/>
            <result column="nineteenJiFen" jdbcType="INTEGER" property="nineteenJiFen"/>
            <result column="jiFen" jdbcType="INTEGER" property="jiFen"/>
            <result column="remark" jdbcType="VARCHAR" property="remark"/>
            <result column="status" jdbcType="VARCHAR" property="status"/>
        </association>
        <association property="actProjectTopic" column="id" javaType="com.huacainfo.ace.zcpa.model.ActProjectTopic">
            <id column="aptid" jdbcType="VARCHAR" property="id" />
            <result column="aptareaCode" jdbcType="VARCHAR" property="areaCode" />
            <result column="aptprojectId" jdbcType="VARCHAR" property="projectId" />
            <result column="aptprojectCategory" jdbcType="VARCHAR" property="projectCategory" />
            <result column="apttargetId" jdbcType="VARCHAR" property="targetId" />
            <result column="aptcontent" jdbcType="VARCHAR" property="content" />
            <result column="aptstartTime" jdbcType="TIMESTAMP" property="startTime" />
            <result column="aptendTime" jdbcType="TIMESTAMP" property="endTime" />
            <result column="aptacceptState" jdbcType="VARCHAR" property="acceptState" />
            <result column="aptvolunteerNum" jdbcType="INTEGER" property="volunteerNum" />
            <result column="title" jdbcType="VARCHAR" property="title" />

        </association>

        <collection property="actProjectTarget" column="id" ofType="com.huacainfo.ace.zcpa.vo.ActProjectTargetVo">
            <id column="ptid" jdbcType="VARCHAR" property="id"/>
            <result column="ptareaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="ptprojectId" jdbcType="VARCHAR" property="projectId"/>
            <result column="pttargetId" jdbcType="VARCHAR" property="targetId"/>
            <result column="pttargetType" jdbcType="VARCHAR" property="targetType"/>

            <result column="sschoolName" jdbcType="VARCHAR" property="schoolName" />
            <result column="sunicode" jdbcType="VARCHAR" property="unicode" />
            <result column="sareaCode" jdbcType="VARCHAR" property="areaCode" />
            <result column="sdetailAddr" jdbcType="VARCHAR" property="detailAddr" />
            <result column="sphone" jdbcType="VARCHAR" property="phone" />

            <collection property="actProjectVolunteer" column="id" ofType="com.huacainfo.ace.zcpa.vo.ActProjectVolunteerVo">
                <id column="pvid" jdbcType="VARCHAR" property="id" />
                <result column="pvareaCode" jdbcType="VARCHAR" property="areaCode" />
                <result column="pvprojectId" jdbcType="VARCHAR" property="projectId" />
                <result column="pvtargetId" jdbcType="VARCHAR" property="targetId" />
                <result column="pvvolunteerId" jdbcType="VARCHAR" property="volunteerId" />

                <result column="bvsex" jdbcType="VARCHAR" property="sex" />
                <result column="bvname" jdbcType="VARCHAR" property="name" />
                <result column="bvmobile" jdbcType="VARCHAR" property="mobile" />
                <result column="bvidCard" jdbcType="VARCHAR" property="idCard" />
                <result column="bvuserType" jdbcType="VARCHAR" property="userType" />
            </collection>
        </collection>


    </resultMap>

    <sql id="From_Statement_List1">
	 from act_project t
	 left join act_project_target pt on t.id=pt.projectId
     left join act_school s on s.id =pt.targetId
     left join act_project_volunteer pv on pv.targetId=pt.id
     left join base_volunteer bv on bv.id = pv.volunteerId
     left join act_project_topic apt on apt.projectId=t.id
    left join  portal_zcpa.province p on p.code=t.areaCode
	</sql>

    <select id="selectSchoolById" parameterType="java.lang.String" resultMap="VoResultMap3">
        select
        <include refid="Vo_Column_List"/>,p.name as areaName,
        <include refid="Vo_ActSchool_List"/>,
        <include refid="Vo_ActProjectVolunteer_List"/>,
        <include refid="Vo_ActProjectTarget_List"/>,
        <include refid="Vo_baseVolunteer_List"/>,
        <include refid="Vo_ActProjectTopic_List"/>
        <include refid="From_Statement_List1"/>
        where t.id= #{id,jdbcType=VARCHAR} and t.category='2'
    </select>

    <resultMap id="VoResultMap4" type="com.huacainfo.ace.zcpa.vo.ActProjectVo" extends="BaseResultMap">
        <result column="areaName" jdbcType="VARCHAR" property="areaName"/>
        <association property="actProject" column="id" javaType="com.huacainfo.ace.zcpa.model.ActProject">
            <id column="id" jdbcType="VARCHAR" property="id"/>
            <result column="projectCode" jdbcType="VARCHAR" property="projectCode"/>
            <result column="projectName" jdbcType="VARCHAR" property="projectName"/>
            <result column="projectLevel" jdbcType="VARCHAR" property="projectLevel"/>
            <result column="category" jdbcType="VARCHAR" property="category"/>
            <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="startTime" jdbcType="TIMESTAMP" property="startTime"/>
            <result column="endTime" jdbcType="TIMESTAMP" property="endTime"/>
            <result column="summary" jdbcType="VARCHAR" property="summary"/>
            <result column="projectState" jdbcType="VARCHAR" property="projectState"/>
            <result column="actTimes" jdbcType="INTEGER" property="actTimes"/>
            <result column="overallScore" jdbcType="DECIMAL" property="overallScore"/>
            <result column="partakeDuration" jdbcType="DECIMAL" property="partakeDuration"/>
            <result column="anomalyTimes" jdbcType="INTEGER" property="anomalyTimes"/>
            <result column="fmUrl" jdbcType="VARCHAR" property="fmUrl"/>
            <result column="nineteenJiFen" jdbcType="INTEGER" property="nineteenJiFen"/>
            <result column="jiFen" jdbcType="INTEGER" property="jiFen"/>
            <result column="remark" jdbcType="VARCHAR" property="remark"/>
            <result column="status" jdbcType="VARCHAR" property="status"/>
        </association>
        <association property="actProjectTopic" column="id" javaType="com.huacainfo.ace.zcpa.model.ActProjectTopic">
            <id column="aptid" jdbcType="VARCHAR" property="id" />
            <result column="aptareaCode" jdbcType="VARCHAR" property="areaCode" />
            <result column="aptprojectId" jdbcType="VARCHAR" property="projectId" />
            <result column="aptprojectCategory" jdbcType="VARCHAR" property="projectCategory" />
            <result column="apttargetId" jdbcType="VARCHAR" property="targetId" />
            <result column="aptcontent" jdbcType="VARCHAR" property="content" />
            <result column="aptstartTime" jdbcType="TIMESTAMP" property="startTime" />
            <result column="aptendTime" jdbcType="TIMESTAMP" property="endTime" />
            <result column="aptacceptState" jdbcType="VARCHAR" property="acceptState" />
            <result column="aptvolunteerNum" jdbcType="INTEGER" property="volunteerNum" />
            <result column="title" jdbcType="VARCHAR" property="title" />
        </association>
        <collection property="actProjectVolunteer" column="id" ofType="com.huacainfo.ace.zcpa.vo.ActProjectVolunteerVo">
            <id column="pvid" jdbcType="VARCHAR" property="id"/>
            <result column="pvareaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="pvprojectId" jdbcType="VARCHAR" property="projectId"/>
            <result column="pvvolunteerId" jdbcType="VARCHAR" property="volunteerId"/>
            <result column="pvisSignUp" jdbcType="VARCHAR" property="isSignUp"/>

            <result column="bvsex" jdbcType="VARCHAR" property="sex" />
            <result column="bvname" jdbcType="VARCHAR" property="name" />
            <result column="bvmobile" jdbcType="VARCHAR" property="mobile" />
            <result column="bvidCard" jdbcType="VARCHAR" property="idCard" />
            <result column="bvuserType" jdbcType="VARCHAR" property="userType" />
        </collection>

    </resultMap>
    <select id="selectOtherById" parameterType="java.lang.String" resultMap="VoResultMap4">
        select
        <include refid="Vo_Column_List"/>,p.name as areaName,
        <include refid="Vo_ActProjectVolunteer_List"/>,
        <include refid="Vo_baseVolunteer_List"/>,
        <include refid="Vo_ActProjectTopic_List"/>
        from act_project t
        left join act_project_volunteer pv on pv.projectId=t.id
        left join base_volunteer bv on bv.id = pv.volunteerId
        left join act_project_topic apt on apt.projectId=t.id
        left join  portal_zcpa.province p on p.code=t.areaCode
        where t.id= #{id,jdbcType=VARCHAR} and t.category=#{category,jdbcType=VARCHAR}
    </select>


    <resultMap id="VoTargetResultMap" type="com.huacainfo.ace.zcpa.vo.TargetVo" >
            <id column="id" jdbcType="VARCHAR" property="id"/>
            <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="projectId" jdbcType="VARCHAR" property="projectId"/>
            <result column="targetId" jdbcType="VARCHAR" property="targetId"/>
            <result column="phone" jdbcType="VARCHAR" property="phone"/>
            <result column="targetName" jdbcType="VARCHAR" property="targetName"/>
            <result column="unicode" jdbcType="VARCHAR" property="unicode"/>
            <result column="detailAddr" jdbcType="VARCHAR" property="detailAddr"/>
            <result column="psex" jdbcType="VARCHAR" property="psex"/>
            <result column="pidCard" jdbcType="VARCHAR" property="pidCard"/>
            <result column="pcateogry" jdbcType="VARCHAR" property="pcateogry"/>
        <collection property="volunteerVo" column="id" ofType="com.huacainfo.ace.zcpa.vo.VolunteerVo">
            <id column="pvid" jdbcType="VARCHAR" property="id"/>
            <result column="pvareaCode" jdbcType="VARCHAR" property="areaCode"/>
            <result column="pvprojectId" jdbcType="VARCHAR" property="projectId"/>
            <result column="pvvolunteerId" jdbcType="VARCHAR" property="volunteerId"/>
            <result column="pvtargetId" jdbcType="VARCHAR" property="targetId"/>
            <result column="pvtargetId" jdbcType="VARCHAR" property="targetId"/>
            <result column="aidTargetType" jdbcType="VARCHAR" property="aidTargetType"/>
            <result column="aidTargetName" jdbcType="VARCHAR" property="aidTargetName"/>

            <result column="bvsex" jdbcType="VARCHAR" property="sex" />
            <result column="bvname" jdbcType="VARCHAR" property="name" />
            <result column="bvmobile" jdbcType="VARCHAR" property="mobile" />
            <result column="bvidCard" jdbcType="VARCHAR" property="idCard" />
            <result column="bvuserType" jdbcType="VARCHAR" property="userType" />
        </collection>
    </resultMap>


    <sql id="Vo_ActPerson">
     p.personName targetName, p.sex psex, p.idCard pidCard, p.cateogry pcateogry, p.phone phone,  p.nowAddr detailAddr
    </sql>

    <sql id="Vo_ActFamilyVolunteer">
    pv.id pvid, pv.areaCode pvareaCode, pv.projectId pvprojectId, pv.targetId pvtargetId, pv.volunteerId pvvolunteerId,pv.aidTargetType
    </sql>

    <sql id="Vo_ActFamilyTarget">
    pt.id , pt.areaCode , pt.projectId , pt.personId targetId
    </sql>
    <sql id="Vo_baseVolunteer">
        bv.name bvname, bv.sex bvsex, bv.mobile bvmobile,bv.idCard bvidCard, bv.userType bvuserType,
        bv.homeAreaCode bvhomeAreaCode, bv.homeAddr bvhomeAddr,bv.nowAreaCode bvnowAreaCode, bv.nowAddr bvnowAddr
    </sql>

    <sql id="Vo_ActSchool">
       s.schoolName targetName, s.unicode,  s.detailAddr, s.phone
    </sql>

    <sql id="Vo_ActProjectTarget">
    pt.id, pt.areaCode, pt.projectId , pt.targetId
    </sql>
    <sql id="Vo_ActProjectVolunteer">
     pv.id pvid, pv.areaCode pvareaCode, pv.projectId pvprojectId, pv.volunteerId pvvolunteerId,pv.targetId pvtargetId
    </sql>

    <select id="findVolunteerList" parameterType="java.lang.String" resultMap="VoTargetResultMap">
        select
        <choose>
            <when test='category!=null and category=="1"'>
                <include refid="Vo_ActFamilyVolunteer"/>,(select name from portal_zcpa.dict where code=pv.aidTargetType and categoryId='49')as aidTargetName,
                <include refid="Vo_baseVolunteer"/>, v.* from (select
                <include refid="Vo_ActPerson"/>,
                <include refid="Vo_ActFamilyTarget"/>
                from act_family_target pt
                left join act_person p on pt.personId = p.id
                where pt.projectId =#{projectId,jdbcType=VARCHAR} and
                (select count(1) from act_family_volunteer ff where ff.targetId = pt.id and  volunteerId IS NOT NULL)<![CDATA[ < ]]>4
                and  pt.areaCode like concat(#{areaCode,jdbcType=VARCHAR},'%')
            </when>
            <otherwise>
                <include refid="Vo_ActProjectVolunteer"/>,
                <include refid="Vo_baseVolunteer"/>, v.* from (select
                <include refid="Vo_ActProjectTarget"/>,
                <include refid="Vo_ActSchool"/>
                from act_project_target pt
                left join act_school s on s.id =pt.targetId
                where pt.projectId =#{projectId,jdbcType=VARCHAR} and  s.areaCode like concat(#{areaCode,jdbcType=VARCHAR},'%')
            </otherwise>
        </choose>

        <choose>
            <when test='orderBy!=null and orderBy!=""'>
                ORDER BY ${orderBy}
            </when>
            <otherwise>
                ORDER BY pt.createDate desc
            </otherwise>
        </choose>
        limit #{start,jdbcType=DECIMAL}, #{limit,jdbcType=DECIMAL} )v
        <choose>
            <when test='category!=null and category=="1"'>
                left join act_family_volunteer pv on pv.targetId=v.id
                left join base_volunteer bv on bv.id = pv.volunteerId
            </when>
            <otherwise>
                left join act_project_volunteer pv on pv.targetId=v.id
                left join base_volunteer bv on bv.id = pv.volunteerId
            </otherwise>
        </choose>

    </select>

    <select id="findVolunteerCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM (
        SELECT pt.id
        <choose>
            <when test='category!=null and category=="1"'>
                from act_family_target pt
                left join act_person p on pt.personId = p.id
                left join act_family_volunteer pv on pv.targetId=pt.id
                left join base_volunteer bv on bv.id = pv.volunteerId
                where pt.projectId =#{projectId,jdbcType=VARCHAR} and (select count(1) from act_family_volunteer ff where ff.targetId = pt.id and  volunteerId IS NOT NULL)<![CDATA[ < ]]>4
                and  pt.areaCode like concat(#{areaCode,jdbcType=VARCHAR},'%')
            </when>
            <otherwise>
                from act_project_target pt
                left join act_school s on s.id =pt.targetId
                left join act_project_volunteer pv on pv.targetId=pt.id
                left join base_volunteer bv on bv.id = pv.volunteerId
                where pt.projectId =#{projectId,jdbcType=VARCHAR}  and  s.areaCode like concat(#{areaCode,jdbcType=VARCHAR},'%')
            </otherwise>
        </choose>
        GROUP by pt.id
        ) a
    </select>


    <select id="findPid" parameterType="java.lang.String" resultType="java.lang.String">
         select id from act_project
        where areaCode = #{areaCode,jdbcType=VARCHAR} and  category=#{category,jdbcType=VARCHAR} and projectLevel='0'
    </select>


    <select id="findVolunteerDockedList" parameterType="java.lang.String" resultMap="VoTargetResultMap">
        select
            <include refid="Vo_ActFamilyVolunteer"/>,
            <include refid="Vo_baseVolunteer"/>, v.* from (select
            <include refid="Vo_ActPerson"/>,
            <include refid="Vo_ActFamilyTarget"/>
            from act_family_target pt
            left join act_person p on pt.personId = p.id
            where pt.projectId =#{projectId,jdbcType=VARCHAR} and pt.areaCode like concat(#{areaCode,jdbcType=VARCHAR},'%')
            and   (select count(1) from act_family_volunteer ff where ff.targetId = pt.id and  volunteerId IS NOT NULL)=4
           <choose>
             <when test='orderBy!=null and orderBy!=""'>
                ORDER BY ${orderBy}
            </when>
            <otherwise>
                ORDER BY pt.createDate desc
            </otherwise>
        </choose>
        limit #{start,jdbcType=DECIMAL}, #{limit,jdbcType=DECIMAL} )v
        left join act_family_volunteer pv on pv.targetId=v.id
        left join base_volunteer bv on bv.id = pv.volunteerId
    </select>


    <select id="findVolunteerDockedCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM (
        SELECT pt.id
        from act_family_target pt
        left join act_person p on pt.personId = p.id
        left join act_family_volunteer pv on pv.targetId=pt.id
        left join base_volunteer bv on bv.id = pv.volunteerId
        where pt.projectId =#{projectId,jdbcType=VARCHAR} and pt.areaCode like concat(#{areaCode,jdbcType=VARCHAR},'%')
        and  (select count(1) from act_family_volunteer ff where ff.targetId = pt.id and  volunteerId IS NOT NULL)=4
        GROUP by pt.id
        ) a
    </select>

   <select id="isdelete" resultType="java.lang.Integer">
    SELECT count(1) FROM act_project where pid=#{id,jdbcType=VARCHAR} and projectState!='4';
   </select>
</mapper>
