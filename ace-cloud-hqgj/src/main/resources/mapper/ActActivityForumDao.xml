<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huacainfo.ace.zcpa.dao.ActActivityForumDao">
    <resultMap id="BaseResultMap" type="com.huacainfo.ace.zcpa.model.ActActivityForum">
        <id column="id" jdbcType="VARCHAR" property="id"/>
        <result column="activityId" jdbcType="VARCHAR" property="activityid"/>
        <result column="userId" jdbcType="VARCHAR" property="userid"/>
        <result column="commentText" jdbcType="VARCHAR" property="commenttext"/>
        <result column="commentTime" jdbcType="TIMESTAMP" property="commenttime"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="createDate" jdbcType="TIMESTAMP" property="createdate"/>
        <result column="postingId" jdbcType="VARCHAR" property="postingId"/>

    </resultMap>
    <sql id="Base_Column_List">
    id, activityId, userId, commentText, commentTime, remark, status, createDate,postingId
  </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from act_activity_forum
        where id = #{id,jdbcType=VARCHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from act_activity_forum
    where id = #{id,jdbcType=VARCHAR}
  </delete>
    <insert id="insert" parameterType="com.huacainfo.ace.zcpa.model.ActActivityForum">
    insert into act_activity_forum (id, activityId, userId,
      commentText, commentTime, remark,
      status, createDate,postingId)
    values (#{id,jdbcType=VARCHAR}, #{activityid,jdbcType=VARCHAR}, #{userid,jdbcType=VARCHAR},
      #{commenttext,jdbcType=VARCHAR}, #{commenttime,jdbcType=TIMESTAMP}, #{remark,jdbcType=VARCHAR},
      #{status,jdbcType=VARCHAR}, #{createdate,jdbcType=TIMESTAMP},#{postingId,jdbcType=VARCHAR})
  </insert>

    <update id="updateByPrimaryKey" parameterType="com.huacainfo.ace.zcpa.model.ActActivityForum">
    update act_activity_forum
    set activityId = #{activityid,jdbcType=VARCHAR},
      userId = #{userid,jdbcType=VARCHAR},
      commentText = #{commenttext,jdbcType=VARCHAR},
      commentTime = #{commenttime,jdbcType=TIMESTAMP},
      remark = #{remark,jdbcType=VARCHAR},
      status = #{status,jdbcType=VARCHAR},
      createDate = #{createdate,jdbcType=TIMESTAMP},
      postingId = #{postingId,jdbcType=VARCHAR}
    where id = #{id,jdbcType=VARCHAR}
  </update>
    <resultMap extends="BaseResultMap" id="VoResultMap" type="com.huacainfo.ace.zcpa.vo.ActActivityForumVo">
        <result column="userName" jdbcType="VARCHAR" property="userName"/>
    </resultMap>
    <sql id="Vo_Column_List">
    t.id, t.activityId,t.postingId ,t.userId, t.commentText, t.commentTime, t.remark, t.status, t.createDate
  </sql>
    <sql id="From_Statement">
    FROM act_activity_forum t
    left join  portal_zcpa.users u on t.userId=u.user_id
  </sql>
    <sql id="Where_Condition">
        <where>
            1 = 1
            <if test="condition.activityTitle != null and condition.activityTitle !=''">
                and t.activityTitle = #{condition.activityTitle,jdbcType=VARCHAR}
            </if>
            <if test="condition.category != null and condition.category !=''">
                and t.category = #{condition.category,jdbcType=VARCHAR}
            </if>
            <if test="condition.category != null and condition.userId !=''">
                and t.userId = #{condition.userId,jdbcType=VARCHAR}
            </if>
        </where>
    </sql>
    <select id="selectVoByPrimaryKey" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List"/>
        <include refid="From_Statement"/>
        where t.id = #{id,jdbcType=VARCHAR}
    </select>
    <select id="findList" parameterType="java.lang.String" resultMap="VoResultMap">
        select
        <include refid="Vo_Column_List"/>,u.name userName
        <include refid="From_Statement"/>
        <include refid="Where_Condition"/>
        <choose>
            <when test='orderBy!=null and orderBy!=""'>
                ORDER BY ${orderBy}
            </when>
            <otherwise>

                ORDER BY t.createDate desc
            </otherwise>
        </choose>

    </select>
    <select id="findCount" resultType="int">
        SELECT COUNT(*)
        <include refid="From_Statement"/>
        <include refid="Where_Condition"/>
    </select>
    <select id="isExist" parameterType="com.huacainfo.ace.zcpa.model.ActActivityForum" resultType="int">
            select count(1)
        from act_activity_forum
        where id = #{id,jdbcType=VARCHAR}
  </select>

    <delete id="deleteByIds">
        delete from act_activity_forum
        where id in
        <foreach collection="array" item="ids" open="(" separator="," close=")">
            #{ids}
        </foreach>
    </delete>
    <update id="updateState" parameterType="com.huacainfo.ace.zcpa.model.ActActivityForum">
     update act_activity_assess
     set status = #{status,jdbcType=VARCHAR},
     where id = #{id,jdbcType=VARCHAR}
    </update>

    <delete id="deleteByPostingIds">
        delete from act_activity_forum
        where postingId in
        <foreach collection="array" item="ids" open="(" separator="," close=")">
            #{ids}
        </foreach>
    </delete>

    <resultMap extends="BaseResultMap" id="ForumVoRsMap" type="com.huacainfo.ace.zcpa.vo.ForumVo">
        <result column="userName" jdbcType="VARCHAR" property="userName"/>
        <result column="fornumId" jdbcType="VARCHAR" property="fornumId"/>
        <result column="admirerNum" jdbcType="INTEGER" property="admirerNum"/>
        <result column="admirerState" jdbcType="INTEGER" property="admirerState"/>
        <result column="reportedNum" jdbcType="INTEGER" property="reportedNum"/>
        <result column="blackStatus" jdbcType="INTEGER" property="blackStatus"/>
        <result column="selfForumState" jdbcType="INTEGER" property="selfForumState"/>
        <result column="headimgurl" jdbcType="VARCHAR" property="headimgurl"/>

        <collection property="attachList" column="attachId" ofType="com.huacainfo.ace.zcpa.model.ActActivityAttach">
            <id column="attachId" jdbcType="VARCHAR" property="id"/>
            <result column="actId" jdbcType="VARCHAR" property="actid"/>
            <result column="fileURL" jdbcType="VARCHAR" property="fileurl"/>
        </collection>
    </resultMap>


    <select id="findForumList" resultMap="ForumVoRsMap" resultType="com.huacainfo.ace.zcpa.vo.ForumVo">
        SELECT
        a.id as attachId, a.actId, a.fileURL,
        vv.id, vv.fornumId, vv.userId, vv.userName,
        vv.activityId, vv.postingId, vv.commentText, vv.commentTime,
        vv.admirerNum, vv.admirerState, vv.reportedNum,vv.blackStatus, vv.selfForumState,vv.headimgurl
        from (
        select
        v.id, v.id as fornumId, v.userId, v.userName,
        v.activityId, v.postingId, v.commentText, v.commentTime,
        v.admirerNum, v.admirerState, v.reportedNum,v.blackStatus, v.selfForumState,v.headimgurl
        from (
        select
        t.id, t.id as fornumId,
        t.userId, b.name as userName,
        t.activityId, t.postingId, t.commentText, t.commentTime,w.headimgurl,
        -- 该回帖被点赞次数,被举报次数,被禁止发帖
        (select count(1) from act_admirer_forum a where a.forumId= t.id ) as admirerNum,
        (select count(1) from act_activity_report r where r.postingId=t.id ) as reportedNum,
        (select count(1) from act_poster_blacklist a where a.postingId = t.userId) as blackStatus,
        <choose>
            <when test="condition.userId != null and condition.userId !=''">
                -- 当前用户点赞状态
                (select count(1) from act_admirer_forum a
                where a.forumId = t.id and a.userId = #{condition.userid}
                ) as admirerState,
                case when t.userId = #{condition.userid} then 1 else 0 end AS selfForumState
            </when>
            <otherwise>
                0 as admirerState, 0 AS selfForumState
            </otherwise>
        </choose>
        from act_activity_forum t
        left join base_volunteer b on t.userId = b.id
        left join wechat_user w on b.unionid=w.unionid
        where t.postingId = #{condition.postingId,jdbcType=VARCHAR}
        )v

        )vv
        left join act_activity_attach a on vv.id = a.actId
        <choose>
            <when test='orderBy!=null and orderBy!=""'>
                ORDER BY vv.${orderBy}
            </when>
            <otherwise>
                ORDER BY vv.admirerNum desc
            </otherwise>
        </choose>
        limit #{start,jdbcType=INTEGER}, #{limit,jdbcType=INTEGER}
    </select>
    <select id="findForumListCount" resultType="java.lang.Integer">
        select  count(1)
        from act_activity_forum t
        left join base_volunteer b on t.userId = b.id
        where t.postingId = #{condition.postingId,jdbcType=VARCHAR}
    </select>

</mapper>
