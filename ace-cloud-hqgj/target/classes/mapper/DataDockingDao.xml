<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huacainfo.ace.zcpa.dao.DataDockingDao">


    <resultMap id="VoResultMap3" type="com.huacainfo.ace.zcpa.dataVo.AreaCodeNumVo">
        <result column="areaName" jdbcType="VARCHAR" property="areaName"/>
        <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
        <result column="num" jdbcType="INTEGER" property="num"/>

    </resultMap>

    <select id="findVolunteerNum" resultMap="VoResultMap3" parameterType="java.lang.String">
        select t.areaCode, count(1)as num, case zp.type
        when '4' then   '常德市'
        when '3' then   concat_ws(">",'常德市',zp.name)
        when '2' then   concat_ws(">", ppp.ppNames,pp.pName,zp.name)
        when '1' then   concat_ws(">",'常德市', ppp.ppNames,pp.pName,zp.name)
        end  areaName
        from base_volunteer t
        left join  portal_zcpa.province zp on zp.code=t.areaCode
        left join (	select
        name as pName, p.`code` as pCode, parent_code as ppCode
        from portal_zcpa.province p
        )pp on pp.pCode = zp.parent_code
        left join  (select
        name as ppNames, p.`code` as pppcode
        from portal_zcpa.province p
        )ppp on ppp.pppcode = pp.ppCode
        where   1=1 and t.status='1'
        <if test="condition.startTime != null">
            and t.createDate <![CDATA[ >= ]]> #{condition.startTime,jdbcType=TIMESTAMP}
        </if>
        <if test="condition.endTime != null">
            and t.createDate <![CDATA[ <= ]]> #{condition.endTime,jdbcType=TIMESTAMP}
        </if>
        GROUP BY t.areaCode
    </select>


    <select id="findProjectNum" resultMap="VoResultMap3" parameterType="java.lang.String">
        select t.areaCode, count(1)as num, case zp.type
        when '4' then   '常德市'
        when '3' then   concat_ws(">",'常德市',zp.name)
        when '2' then   concat_ws(">", ppp.ppNames,pp.pName,zp.name)
        when '1' then   concat_ws(">",'常德市', ppp.ppNames,pp.pName,zp.name)
        end  areaName
        from act_project t
        left join  portal_zcpa.province zp on zp.code=t.areaCode
        left join (	select
        name as pName, p.`code` as pCode, parent_code as ppCode
        from portal_zcpa.province p
        )pp on pp.pCode = zp.parent_code
        left join  (select
        name as ppNames, p.`code` as pppcode
        from portal_zcpa.province p
        )ppp on ppp.pppcode = pp.ppCode
         where 1=1 and (t.projectState='2' or t.projectState='4')
        <if test="condition.startTime != null">
            and t.createDate <![CDATA[ >= ]]> #{condition.startTime,jdbcType=TIMESTAMP}
        </if>
        <if test="condition.endTime != null">
            and t.createDate <![CDATA[ <= ]]> #{condition.endTime,jdbcType=TIMESTAMP}
        </if>
        GROUP BY t.areaCode
    </select>


    <resultMap id="VoResultMap" type="com.huacainfo.ace.zcpa.dataVo.FamilyTargetVo">
        <result column="personName" jdbcType="VARCHAR" property="personName"/>
        <result column="idCard" jdbcType="VARCHAR" property="idCard"/>
        <result column="bingDate" jdbcType="TIMESTAMP" property="bingDate"/>
    </resultMap>

    <select id="findFamilyTargetList" resultMap="VoResultMap" parameterType="java.lang.String">
        select DISTINCT ap.personName,ap.idCard,t.createDate as bingDate
        from act_family_target t
        left join act_project p on t.projectId=p.id
        left join act_person ap on ap.id=t.personId
        where 1=1
        and (p.projectState='2' or p.projectState='4') and  p.category='1'
        <if test="condition.startTime != null">
            and t.createDate <![CDATA[ >= ]]> #{condition.startTime,jdbcType=TIMESTAMP}
        </if>
        <if test="condition.endTime != null">
            and t.createDate <![CDATA[ <= ]]> #{condition.endTime,jdbcType=TIMESTAMP}
        </if>
    </select>


    <resultMap id="VoResultMap1" type="com.huacainfo.ace.zcpa.dataVo.FamilyTargetListVo">
        <result column="personName" jdbcType="VARCHAR" property="personName"/>
        <result column="idCard" jdbcType="VARCHAR" property="idCard"/>
        <result column="bingDate" jdbcType="TIMESTAMP" property="bingDate"/>
        <collection property="familyVolunteerVo" column="id" ofType="com.huacainfo.ace.zcpa.dataVo.FamilyVolunteerVo">
            <result column="name" jdbcType="VARCHAR" property="name"/>
            <result column="vidCard" jdbcType="INTEGER" property="idCard"/>
        </collection>
    </resultMap>

    <select id="findFamilyVolunteertList" resultMap="VoResultMap1" parameterType="java.lang.String">
        select DISTINCT  ap.personName,ap.idCard,t.createDate as bingDate,bv.`name`,bv.idCard as vidCard
        from act_family_target t
        left join act_project p on t.projectId=p.id
        left join act_person ap on ap.id=t.personId
        left join act_family_volunteer v on t.id=v.targetId
        left join  base_volunteer bv on bv.id=v.volunteerId
        where 1=1
        and (p.projectState='2' or p.projectState='4') and  p.category='1' and v.volunteerId is not null
        <if test="condition.startTime != null">
            and t.createDate <![CDATA[ >= ]]> #{condition.startTime,jdbcType=TIMESTAMP}
        </if>
        <if test="condition.endTime != null">
            and t.createDate <![CDATA[ <= ]]> #{condition.endTime,jdbcType=TIMESTAMP}
        </if>
    </select>

    <resultMap id="VoResultMap2" type="com.huacainfo.ace.zcpa.dataVo.ActivityVo">
        <result column="activityId" jdbcType="VARCHAR" property="activityId"/>
        <result column="personId" jdbcType="VARCHAR" property="personId"/>
        <result column="personName" jdbcType="VARCHAR" property="personName"/>
        <result column="idCard" jdbcType="VARCHAR" property="idCard"/>
        <result column="activityTime" jdbcType="TIMESTAMP" property="activityTime"/>
        <result column="areaName" jdbcType="VARCHAR" property="areaName"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="vidCard" jdbcType="VARCHAR" property="vidCard"/>
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="isComplete" jdbcType="VARCHAR" property="isComplete"/>
        <result column="areaCode" jdbcType="VARCHAR" property="areaCode"/>
        <result column="personType" jdbcType="VARCHAR" property="personType"/>
        <collection property="fileURL"  ofType="java.lang.String" javaType="list">
            <result column="fileURL"/>
        </collection>
    </resultMap>

    <select id="findActivityList" resultMap="VoResultMap2" parameterType="java.lang.String">
        select t.id as activityId ,t.areaCode,p.id as personId,p.cateogry as personType, p.personName,p.idCard ,t.startTime as activityTime,t.content,v.`name`,v.idCard as vidCard ,"y" as isComplete,
        a.fileURL,
        case zp.type
        when '4' then   '常德市'
        when '3' then   concat_ws(">",'常德市',zp.name)
        when '2' then   concat_ws(">", ppp.ppNames,pp.pName,zp.name)
        when '1' then   concat_ws(">",'常德市', ppp.ppNames,pp.pName,zp.name)
        end  areaName
        FROM act_project_activity t
        LEFT JOIN act_person p ON t.targetId=p.id
        LEFT JOIN base_volunteer v ON t.volunteerId =v.id
        LEFT JOIN act_project j ON t.projectId =j.id
        LEFT JOIN act_activity_attach a on t.id=a.actId
        left join  portal_zcpa.province zp on zp.code=t.areaCode
        left join (	select
        name as pName, p.`code` as pCode, parent_code as ppCode
        from portal_zcpa.province p
        )pp on pp.pCode = zp.parent_code
        left join  (select
        name as ppNames, p.`code` as pppcode
        from portal_zcpa.province p
        )ppp on ppp.pppcode = pp.ppCode
        where 1=1 and  j.projectState in (2,4) and j.category='1'
        <if test="condition.startTime != null">
            and t.createDate <![CDATA[ >= ]]> #{condition.startTime,jdbcType=TIMESTAMP}
        </if>
        <if test="condition.endTime != null">
            and t.createDate <![CDATA[ <= ]]> #{condition.endTime,jdbcType=TIMESTAMP}
        </if>
    </select>
</mapper>