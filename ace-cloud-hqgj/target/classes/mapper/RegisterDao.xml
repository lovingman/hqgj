<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huacainfo.ace.zcpa.dao.RegisterDao">
    <update id="updatePassword">
        UPDATE portal_zcpa.users
        set `password` = #{newPassword}
        where account = #{account} and isSync='n'
    </update>

    <select id="userIsExist" resultType="int">
        select count(*)
        from portal_zcpa.users
        where account = #{account} and isSync='n'
     </select>
    <select id="isExist" resultType="int">
        select count(*)
        from portal_zcpa.users
        where user_id = #{userId}
     </select>
    <select id="isExistByMobile" resultType="int">
        select count(1)
        from portal_zcpa.users
        where mobile = #{mobile}
    </select>
    <select id="homePage" resultType="java.util.Map">
        select
            b.id as volunteerId, b.`name`,w.headimgurl,
            (SELECT count(*) from act_project_activity t where t.`status` = '1' and t.volunteerId= #{userId} ) as voCount,
            IFNULL(SUM(v.score),0) as score,
            IFNULL(SUM(v.volHour),0) as volHour
       from base_volunteer b
       left join wechat_user w on b.unionid=w.unionid
       left join (
            SELECT
                t.volunteerId,
                IFNULL(t.activityJiFen,0) as score,
                CASE when ISNULL(t.startTime) then 0
                when ISNULL(t.endTime) then 0
                ELSE timestampdiff(HOUR,t.startTime, t.endTime) END volHour
            FROM `act_project_activity` t
            where t.`status` = '1'
            and t.volunteerId = #{userId}
        )v on v.volunteerId = b.id
        where b.id = #{userId}
        group by v.volunteerId, b.`name`
    </select>
    <select id="getAreaCode" resultType="java.util.Map">
         select
            IFNULL(t.areaCode,'') as areaCode,
            case p.type
                when '4' then   '常德市'
                when '3' then   concat_ws(">",'常德市',p.name)
                when '2' then   concat_ws(">", ppp.ppNames,pp.pName,p.name)
                when '1' then   concat_ws(">",'常德市', ppp.ppNames,pp.pName,p.name)
                end  areaName
        from portal_zcpa.users t
         left join  portal_zcpa.province p on p.code=t.areaCode
                left join (	select
                name as pName, p.`code` as pCode, parent_code as ppCode
                from portal_zcpa.province p
                )pp on pp.pCode = p.parent_code
                left join  (select
                name as ppNames, p.`code` as pppcode
                from portal_zcpa.province p
                )ppp on ppp.pppcode = pp.ppCode
        where t.curSyid = #{sysId,jdbcType=VARCHAR}
            and t.user_id = #{userId,jdbcType=VARCHAR}
    </select>

    <insert id="insertUser" parameterType="com.huacainfo.ace.common.security.model.Users">
        insert into portal_zcpa.users (user_id, account, password, sex, idCard, name,
                           corpId, areaCode, birthday, status, lastLoginTime, mobile,
                           email, createTime, curSyid, locked, lockedTime, deptId, userType,isSync)
        values (#{userId,jdbcType=VARCHAR}, #{account,jdbcType=VARCHAR}, #{password,jdbcType=VARCHAR},
                #{sex,jdbcType=VARCHAR}, #{idCard,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR},
                #{corpId,jdbcType=VARCHAR}, #{areaCode,jdbcType=VARCHAR}, #{birthday,jdbcType=DATE},
                #{status,jdbcType=VARCHAR}, #{lastLoginTime,jdbcType=TIMESTAMP}, #{mobile,jdbcType=VARCHAR},
                #{email,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, #{curSyid,jdbcType=VARCHAR},
                #{locked,jdbcType=VARCHAR}, #{lockedTime,jdbcType=TIMESTAMP}, #{deptId,jdbcType=VARCHAR},
                #{userType,jdbcType=VARCHAR},#{isSync,jdbcType=VARCHAR}
                )
     </insert>


    <update id="updateUser" parameterType="com.huacainfo.ace.common.security.model.Users">
    update portal_zcpa.users
    set sex = #{sex,jdbcType=VARCHAR},
      userType = #{userType,jdbcType=VARCHAR},
      areaCode = #{areaCode,jdbcType=VARCHAR},
      deptId=#{deptId,jdbcType=VARCHAR}
    where user_id = #{userId,jdbcType=VARCHAR}
  </update>

    <delete id="deleteByIds">
        delete from portal_zcpa.users
        where user_id in
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <insert id="insertUserRole" parameterType="java.lang.String">
         insert into portal_zcpa.users_role(user_id,role_id,create_time)
           values (#{userid,jdbcType=VARCHAR},#{roleid,jdbcType=VARCHAR},now())
    </insert>

    <select id="isUnionid" parameterType="java.lang.String" resultType="int">
            select count(1)
        from base_volunteer
        where unionid = #{unionid,jdbcType=VARCHAR}
  </select>



</mapper>
